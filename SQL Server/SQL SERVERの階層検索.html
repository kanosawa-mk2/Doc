<html>
<head>
  <title>Evernote Export</title>
  <basefont face="メイリオ" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/277494; Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: メイリオ;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="658"/>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><b style="font-size: 15px;">SQL SERVERの階層検索</b><div>-------------------------------------------------------------------------------</div><div>テーブル情報</div><div><br/></div><div>CREATE TABLE [SPUser].[ORG_TBL](<br/>
     [ORG_CD] [varchar](8) NOT NULL,<br/>
     [PARENT_ORG_CD] [varchar](8) NULL,<br/>
     [ORG_NAME] [varchar](50) NOT NULL,<br/>
     [ORG_LV] [numeric](1, 0) NOT NULL<br/>
) ON [PRIMARY]<br/><br/></div><div>テストデータ</div><div><img src="SQL SERVERの階層検索_files/Image.png" type="image/png" style="cursor: default;cursor: default;"/></div><div><br/></div><div><br/></div><div><br/></div><div>---------------------------------------------------------</div><div>階層検索クエリ</div><div>---------------------------------------------------------</div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">DECLARE</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">@org</span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">varchar</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">8</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">);</span></font></div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">set</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">@org</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">=</span></font> <font color="#FF0000" face="Times New Roman" size="1"><span style="font-size:9pt">'ORG01000'</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">;</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt"><br/></span></font></div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">WITH</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">CTE</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[PARENT_ORG_CD]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD2]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_NAME]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_LV]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[lv]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">)</span></font></div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">AS</span></font></div><div align="left"><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">SELECT</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[PARENT_ORG_CD]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#FF00FF" face="Times New Roman" size="1"><span style="font-size:9pt">CONVERT</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">varchar</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">15</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">),</span></font><font color="#FF00FF" face="Times New Roman" size="1"><span style="font-size:9pt">SPACE</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_LV]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">)</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">+</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">)</span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">AS</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD2]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_NAME]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_LV]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">1</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">FROM</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[SPDB]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[SPUser]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_TBL]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">WHERE</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">=</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">@org</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt"> </span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">UNION</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">ALL</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">         </span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">   </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">SELECT</span></font><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">    </span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[PARENT_ORG_CD]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#FF00FF" face="Times New Roman" size="1"><span style="font-size:9pt">CONVERT</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">varchar</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">15</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">),</span></font><font color="#FF00FF" face="Times New Roman" size="1"><span style="font-size:9pt">SPACE</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">(</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_LV]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">)</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">+</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">)</span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">AS</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD2]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_NAME]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_LV]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">,</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">CTE</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[lv]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">+</span></font> <font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">1</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">FROM</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[SPDB]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[SPUser]</span></font><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_TBL]</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                </span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">INNER</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">JOIN</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">CTE</span></font></div><div align="left"><font color="#010101" face="Times New Roman" size="1"><span style="font-size:9pt">                </span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">ON</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[T1]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[ORG_CD]</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">=</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">CTE</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">.</span></font><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">[PARENT_ORG_CD]</span></font></div><div align="left"><font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">)</span></font></div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">SELECT</span></font> <font color="#808080" face="Times New Roman" size="1"><span style="font-size:9pt">*</span></font></div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">FROM</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">CTE</span></font></div><div align="left"><font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">Order</span></font> <font color="#0000FF" face="Times New Roman" size="1"><span style="font-size:9pt">by</span></font> <font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt">ORG_LV</span></font></div><div align="left"><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt"><br/></span></font></div><div align="left"><img src="SQL SERVERの階層検索_files/Image [1].png" type="image/png" style="cursor: default;cursor: default;"/></div><div align="left"><font color="#008080" face="Times New Roman" size="1"><span style="font-size:9pt"><br/></span></font></div><div align="left">  </div></span>
</div></body></html> 